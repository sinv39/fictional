# Dockeréƒ¨ç½²æ•™ç¨‹

## ğŸ¯ éƒ¨ç½²æ–¹æ¡ˆ

æœ¬é¡¹ç›®é‡‡ç”¨**æœ¬åœ°ç¼–è¯‘ + Dockeréƒ¨ç½²**çš„æ–¹å¼ï¼š

1. åœ¨æœ¬åœ°Windowsç¯å¢ƒç¼–è¯‘åç«¯å’Œå‰ç«¯
2. ä¸Šä¼ ç¼–è¯‘äº§ç‰©åˆ°æœåŠ¡å™¨
3. ä½¿ç”¨Docker Composeä¸€é”®éƒ¨ç½²

---

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinuxï¼ˆUbuntu 20.04+æ¨èï¼‰
- **Docker**ï¼š20.10+
- **Docker Compose**ï¼š1.29+
- **ç«¯å£**ï¼š10100ï¼ˆå‰ç«¯ï¼‰ã€10104ï¼ˆåç«¯ï¼‰

### 2. å¤–éƒ¨æœåŠ¡

- **MySQLæ•°æ®åº“**ï¼š123.60.40.72:10101
- **MinIOå¯¹è±¡å­˜å‚¨**ï¼š123.60.40.72:10102

### 3. æœ¬åœ°ç¯å¢ƒ

- **JDK**ï¼š17+
- **Maven**ï¼š3.6+
- **Node.js**ï¼š18+
- **npm**ï¼š9+

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåœ¨æœ¬åœ°ç¼–è¯‘

#### 1.1 ç¼–è¯‘åç«¯

```bash
# åœ¨Windowsæœ¬åœ°
cd C:\gitRepos\fictional\backend
mvn clean package -DskipTests
```

**éªŒè¯**ï¼š
```bash
# ç¡®è®¤jaråŒ…å·²ç”Ÿæˆ
dir target\fictional-1.0-SNAPSHOT.jar
```

#### 1.2 æ„å»ºå‰ç«¯

```bash
# åœ¨Windowsæœ¬åœ°
cd C:\gitRepos\fictional\frontend
npm install
npm run build
```

**éªŒè¯**ï¼š
```bash
# ç¡®è®¤distç›®å½•å·²ç”Ÿæˆ
dir dist
```

---

### ç¬¬äºŒæ­¥ï¼šä¸Šä¼ åˆ°æœåŠ¡å™¨

#### 2.1 ä¸Šä¼ åç«¯jaråŒ…

```bash
scp C:\gitRepos\fictional\backend\target\fictional-1.0-SNAPSHOT.jar root@123.60.40.72:/home/fiction/backend/target/
```

#### 2.2 ä¸Šä¼ å‰ç«¯distç›®å½•

```bash
scp -r C:\gitRepos\fictional\frontend\dist root@123.60.40.72:/home/fiction/frontend/
```

#### 2.3 ä¸Šä¼ nginxé…ç½®

```bash
scp C:\gitRepos\fictional\frontend\nginx.conf root@123.60.40.72:/home/fiction/frontend/
```

#### 2.4 ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶

```bash
scp -r C:\gitRepos\fictional\deploy root@123.60.40.72:/home/fiction/
```

#### 2.5 ä¸Šä¼ åç«¯Dockerfile

```bash
scp C:\gitRepos\fictional\deploy\Dockerfile root@123.60.40.72:/home/fiction/backend/
```

æˆ–è€…ä½¿ç”¨SFTPå·¥å…·ï¼ˆWinSCP/FileZillaï¼‰ä¸Šä¼ ã€‚

---

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è„šæœ¬

```bash
# è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡å™¨
mysql -h 123.60.40.72 -P 10101 -u root -p

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
source /home/fiction/docs/sql/init.sql;

# æ‰§è¡Œæ›´æ–°è„šæœ¬
source /home/fiction/docs/sql/update-application-table.sql;

# é€€å‡º
exit;
```

æˆ–è€…ä¸Šä¼ SQLæ–‡ä»¶åæ‰§è¡Œï¼š

```bash
scp C:\gitRepos\fictional\docs\sql\init.sql root@123.60.40.72:/tmp/
scp C:\gitRepos\fictional\docs\sql\update-application-table.sql root@123.60.40.72:/tmp/

ssh root@123.60.40.72
mysql -h 123.60.40.72 -P 10101 -u root -p fiction < /tmp/init.sql
mysql -h 123.60.40.72 -P 10101 -u root -p fiction < /tmp/update-application-table.sql
```

---

### ç¬¬å››æ­¥ï¼šåœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²

#### 4.1 è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh root@123.60.40.72
```

#### 4.2 æ£€æŸ¥æ–‡ä»¶

```bash
cd /home/fiction

# æ£€æŸ¥ç›®å½•ç»“æ„
ls -la

# æ£€æŸ¥å…³é”®æ–‡ä»¶
ls -lh backend/target/fictional-1.0-SNAPSHOT.jar
ls -lh frontend/dist/index.html
ls -lh frontend/nginx.conf
ls -lh deploy/docker-compose.yml
```

#### 4.3 è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
cd /home/fiction/deploy
chmod +x deploy.sh
bash ./deploy.sh
```

---

## ğŸ“Š éƒ¨ç½²è„šæœ¬æ‰§è¡Œæµç¨‹

```
[1/6] æ£€æŸ¥Dockerç¯å¢ƒ
      â†“
[2/6] åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
      â†“
[3/6] æ£€æŸ¥ç¼–è¯‘äº§ç‰©ï¼ˆjar + distï¼‰
      â†“
[4/6] æ„å»ºDockeré•œåƒ
      â”œâ”€ åç«¯ï¼šfictional-backend:1.2.0
      â””â”€ å‰ç«¯ï¼šfictional-frontend:1.2.0
      â†“
[5/6] å¯åŠ¨å®¹å™¨
      â”œâ”€ fictional-backend (ç«¯å£10104)
      â””â”€ fictional-frontend (ç«¯å£10100)
      â†“
[6/6] ç­‰å¾…æœåŠ¡å¯åŠ¨
      â†“
   éƒ¨ç½²å®Œæˆï¼
```

---

## ğŸ” éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
cd /home/fiction/deploy
docker-compose ps
```

**é¢„æœŸè¾“å‡º**ï¼š

```
NAME                  STATUS    PORTS
fictional-backend     Up        0.0.0.0:10104->10104/tcp
fictional-frontend    Up        0.0.0.0:10100->80/tcp
```

### 2. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# åªçœ‹åç«¯
docker-compose logs -f fictional-backend

# åªçœ‹å‰ç«¯
docker-compose logs -f fictional-frontend
```

### 3. æµ‹è¯•API

```bash
# æµ‹è¯•åç«¯
curl http://localhost:10104/api/cover/home

# æµ‹è¯•å‰ç«¯
curl http://localhost:10100
```

### 4. æµè§ˆå™¨è®¿é—®

- **å‰ç«¯**ï¼šhttp://123.60.40.72:10100
- **åç«¯API**ï¼šhttp://123.60.40.72:10104/api/cover/home

**ç™»å½•æµ‹è¯•**ï¼š
- å­¦å·ï¼šadmin
- å¯†ç ï¼š12345678

---

## ğŸ”§ DockeræœåŠ¡ç®¡ç†

### å¯åŠ¨æœåŠ¡

```bash
cd /home/fiction/deploy
docker-compose start
```

### åœæ­¢æœåŠ¡

```bash
docker-compose stop
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰
docker-compose restart

# é‡å¯åç«¯
docker-compose restart fictional-backend

# é‡å¯å‰ç«¯
docker-compose restart fictional-frontend
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
docker-compose logs -f

# æœ€å100è¡Œ
docker-compose logs --tail=100

# ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶
docker-compose logs > deploy.log
```

### åˆ é™¤å®¹å™¨

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åˆ é™¤å®¹å™¨å’Œé•œåƒ
docker-compose down --rmi all

# åˆ é™¤å®¹å™¨ã€é•œåƒå’Œæ•°æ®å·
docker-compose down --rmi all -v
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ›´æ–°åç«¯

```bash
# 1. æœ¬åœ°é‡æ–°ç¼–è¯‘
cd C:\gitRepos\fictional\backend
mvn clean package -DskipTests

# 2. ä¸Šä¼ æ–°jaråŒ…
scp target\fictional-1.0-SNAPSHOT.jar root@123.60.40.72:/home/fiction/backend/target/

# 3. æœåŠ¡å™¨ä¸Šé‡æ–°æ„å»º
ssh root@123.60.40.72
cd /home/fiction/deploy
docker-compose build fictional-backend
docker-compose up -d fictional-backend
```

### æ›´æ–°å‰ç«¯

```bash
# 1. æœ¬åœ°é‡æ–°æ„å»º
cd C:\gitRepos\fictional\frontend
npm run build

# 2. ä¸Šä¼ distç›®å½•
scp -r dist root@123.60.40.72:/home/fiction/frontend/

# 3. æœåŠ¡å™¨ä¸Šé‡æ–°æ„å»º
ssh root@123.60.40.72
cd /home/fiction/deploy
docker-compose build fictional-frontend
docker-compose up -d fictional-frontend
```

### æ›´æ–°æ•°æ®åº“

```bash
# 1. ä¸Šä¼ æ–°çš„SQLè„šæœ¬
scp docs\sql\update-xxx.sql root@123.60.40.72:/tmp/

# 2. æ‰§è¡ŒSQLè„šæœ¬
ssh root@123.60.40.72
mysql -h 123.60.40.72 -P 10101 -u root -p fiction < /tmp/update-xxx.sql
```

---

## ğŸ“¦ Dockeré•œåƒç®¡ç†

### æŸ¥çœ‹é•œåƒ

```bash
docker images | grep fictional
```

### åˆ é™¤é•œåƒ

```bash
# åˆ é™¤æŒ‡å®šç‰ˆæœ¬
docker rmi fictional-backend:1.2.0
docker rmi fictional-frontend:1.2.0

# åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a
```

### å¯¼å‡ºé•œåƒ

```bash
# å¯¼å‡ºåç«¯
docker save fictional-backend:1.2.0 -o fictional-backend.tar

# å¯¼å‡ºå‰ç«¯
docker save fictional-frontend:1.2.0 -o fictional-frontend.tar
```

### å¯¼å…¥é•œåƒ

```bash
# å¯¼å…¥åç«¯
docker load -i fictional-backend.tar

# å¯¼å…¥å‰ç«¯
docker load -i fictional-frontend.tar
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥

**æ£€æŸ¥æ—¥å¿—**ï¼š
```bash
docker-compose logs fictional-backend
```

**å¸¸è§åŸå› **ï¼š
- æ•°æ®åº“è¿æ¥å¤±è´¥
- ç«¯å£è¢«å ç”¨
- é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ç«¯å£
netstat -tulpn | grep 10104

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
mysql -h 123.60.40.72 -P 10101 -u root -p -e "SELECT 1"
```

### é—®é¢˜2ï¼šå‰ç«¯æ— æ³•è®¿é—®

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥nginxæ—¥å¿—
docker-compose logs fictional-frontend

# æ£€æŸ¥nginxé…ç½®
docker-compose exec fictional-frontend cat /etc/nginx/conf.d/default.conf
```

### é—®é¢˜3ï¼šAPIè¯·æ±‚å¤±è´¥

**æ£€æŸ¥**ï¼š
```bash
# æµ‹è¯•åç«¯ç›´æ¥è®¿é—®
curl http://localhost:10104/api/cover/home

# æµ‹è¯•å‰ç«¯ä»£ç†
curl http://localhost:10100/api/cover/home

# æ£€æŸ¥å®¹å™¨ç½‘ç»œ
docker network ls
docker network inspect deploy_fictional-network
```

### é—®é¢˜4ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**æ£€æŸ¥**ï¼š
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h 123.60.40.72 -P 10101 -u root -p -e "USE fiction; SHOW TABLES;"

# æ£€æŸ¥é˜²ç«å¢™
ufw status
iptables -L -n | grep 10101
```

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

```bash
# ç™»å½•ç³»ç»Ÿåä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
# æˆ–ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ›´æ–°ï¼ˆä½¿ç”¨Argon2åŠ å¯†åçš„å¯†ç ï¼‰
```

### 2. é…ç½®é˜²ç«å¢™

```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
ufw allow 10100/tcp  # å‰ç«¯
ufw allow 10104/tcp  # åç«¯
ufw enable
```

### 3. ä½¿ç”¨HTTPS

```bash
# é…ç½®nginx SSLè¯ä¹¦
# ä¿®æ”¹nginx.confæ·»åŠ SSLé…ç½®
```

### 4. é™åˆ¶Dockerèµ„æº

åœ¨docker-compose.ymlä¸­æ·»åŠ ï¼š

```yaml
services:
  fictional-backend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨

```bash
docker stats fictional-backend fictional-frontend
```

### æŸ¥çœ‹ç£ç›˜ä½¿ç”¨

```bash
# Dockerä½¿ç”¨çš„ç£ç›˜ç©ºé—´
docker system df

# æ¸…ç†æ— ç”¨æ•°æ®
docker system prune -a
```

### å®šæ—¶å¤‡ä»½

åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼š

```bash
#!/bin/bash
# /home/fiction/backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/home/fiction/backups"

mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -h 123.60.40.72 -P 10101 -u root -p'å¯†ç ' fiction > $BACKUP_DIR/fiction_$DATE.sql

# å¤‡ä»½MinIOæ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
# mc mirror minio/videos $BACKUP_DIR/minio_$DATE/

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆï¼š$BACKUP_DIR/fiction_$DATE.sql"
```

æ·»åŠ åˆ°crontabï¼š

```bash
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /home/fiction/backup.sh >> /home/fiction/backup.log 2>&1
```

---

## ğŸ“ å®Œæ•´éƒ¨ç½²å‘½ä»¤é€ŸæŸ¥

### é¦–æ¬¡éƒ¨ç½²

```bash
# 1. æœ¬åœ°ç¼–è¯‘ï¼ˆWindowsï¼‰
cd C:\gitRepos\fictional\backend
mvn clean package -DskipTests

cd C:\gitRepos\fictional\frontend
npm run build

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp backend\target\fictional-1.0-SNAPSHOT.jar root@123.60.40.72:/home/fiction/backend/target/
scp -r frontend\dist root@123.60.40.72:/home/fiction/frontend/
scp frontend\nginx.conf root@123.60.40.72:/home/fiction/frontend/
scp -r deploy root@123.60.40.72:/home/fiction/

# 3. æœåŠ¡å™¨éƒ¨ç½²
ssh root@123.60.40.72
cd /home/fiction/deploy
bash ./deploy.sh
```

### æ—¥å¸¸æ›´æ–°

```bash
# æœ¬åœ°ç¼–è¯‘
cd backend && mvn clean package -DskipTests
cd frontend && npm run build

# ä¸Šä¼ å¹¶é‡å¯
scp backend/target/*.jar root@123.60.40.72:/home/fiction/backend/target/
scp -r frontend/dist root@123.60.40.72:/home/fiction/frontend/

ssh root@123.60.40.72
cd /home/fiction/deploy
docker-compose restart
```

---

## ğŸŒ è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼š

- **å‰ç«¯é¡µé¢**ï¼šhttp://123.60.40.72:10100
- **åç«¯API**ï¼šhttp://123.60.40.72:10104
- **ç®¡ç†å‘˜è´¦å·**ï¼šadmin / 12345678

---

## ğŸ“ æœåŠ¡å™¨ç›®å½•ç»“æ„

```
/home/fiction/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ target/
â”‚   â”‚   â””â”€â”€ fictional-1.0-SNAPSHOT.jar
â”‚   â””â”€â”€ Dockerfile (æ¥è‡ªdeploy/Dockerfile)
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ dist/               # æ„å»ºäº§ç‰©
â”‚   â”œâ”€â”€ nginx.conf          # Nginxé…ç½®
â”‚   â””â”€â”€ Dockerfile.simple   # ç®€åŒ–çš„Dockerfile
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”œâ”€â”€ Dockerfile          # åç«¯Dockerfile
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â””â”€â”€ README.md
â””â”€â”€ docs/
    â””â”€â”€ sql/
        â”œâ”€â”€ init.sql
        â””â”€â”€ update-application-table.sql
```

---

## ğŸ”„ å¿«é€Ÿé‡å¯

```bash
# é‡å¯åç«¯
cd /home/fiction/deploy
docker-compose restart fictional-backend

# é‡å¯å‰ç«¯
docker-compose restart fictional-frontend

# é‡å¯æ‰€æœ‰
docker-compose restart
```

---

## ğŸ› ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹ç«¯å£

ç¼–è¾‘ `deploy/docker-compose.yml`ï¼š

```yaml
services:
  fictional-frontend:
    ports:
      - "8080:80"  # æ”¹ä¸º8080ç«¯å£
```

### é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `deploy/docker-compose.yml`ï¼š

```yaml
services:
  fictional-backend:
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://YOUR_HOST:PORT/fiction...
      - SPRING_DATASOURCE_PASSWORD=YOUR_PASSWORD
```

### é…ç½®èµ„æºé™åˆ¶

```yaml
services:
  fictional-backend:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰

- [ ] æœ¬åœ°ç¼–è¯‘åç«¯æˆåŠŸ
- [ ] æœ¬åœ°æ„å»ºå‰ç«¯æˆåŠŸ
- [ ] æ•°æ®åº“å·²åˆ›å»ºå¹¶æ‰§è¡ŒSQLè„šæœ¬
- [ ] MinIOæœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] æœåŠ¡å™¨å·²å®‰è£…Dockerå’ŒDocker Compose
- [ ] ç«¯å£10100å’Œ10104æœªè¢«å ç”¨

### éƒ¨ç½²å

- [ ] ä¸¤ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œ
- [ ] åç«¯APIå¯è®¿é—®
- [ ] å‰ç«¯é¡µé¢å¯è®¿é—®
- [ ] å¯ä»¥æ­£å¸¸ç™»å½•
- [ ] APIè¯·æ±‚æ­£å¸¸
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# åç«¯æ—¥å¿—
docker-compose logs --tail=200 fictional-backend

# å‰ç«¯nginxæ—¥å¿—
docker-compose exec fictional-frontend cat /var/log/nginx/access.log
docker-compose exec fictional-frontend cat /var/log/nginx/error.log
```

### è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker-compose exec fictional-backend bash

# è¿›å…¥å‰ç«¯å®¹å™¨
docker-compose exec fictional-frontend sh

# æ£€æŸ¥nginxé…ç½®
docker-compose exec fictional-frontend nginx -t
```

### é‡æ–°å®Œæ•´éƒ¨ç½²

```bash
cd /home/fiction/deploy

# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰
docker-compose down --rmi all -v

# é‡æ–°éƒ¨ç½²
bash ./deploy.sh
```

---

**éƒ¨ç½²ç‰ˆæœ¬**ï¼šv1.2.1  
**æ›´æ–°æ—¥æœŸ**ï¼š2025-10-08  
**éƒ¨ç½²æ–¹å¼**ï¼šæœ¬åœ°ç¼–è¯‘ + Dockeréƒ¨ç½²  
**å‰ç«¯ç«¯å£**ï¼š10100  
**åç«¯ç«¯å£**ï¼š10104

ğŸ‰ **éƒ¨ç½²æˆåŠŸåè®°å¾—ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ï¼**

