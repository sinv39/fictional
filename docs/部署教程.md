# Docker部署教程

## 🎯 部署方案

本项目采用**本地编译 + Docker部署**的方式：

1. 在本地Windows环境编译后端和前端
2. 上传编译产物到服务器
3. 使用Docker Compose一键部署

---

## 📋 部署前准备

### 1. 服务器要求

- **操作系统**：Linux（Ubuntu 20.04+推荐）
- **Docker**：20.10+
- **Docker Compose**：1.29+
- **端口**：10100（前端）、10104（后端）

### 2. 外部服务

- **MySQL数据库**：123.60.40.72:10101
- **MinIO对象存储**：123.60.40.72:10102

### 3. 本地环境

- **JDK**：17+
- **Maven**：3.6+
- **Node.js**：18+
- **npm**：9+

---

## 🚀 部署步骤

### 第一步：在本地编译

#### 1.1 编译后端

```bash
# 在Windows本地
cd C:\gitRepos\fictional\backend
mvn clean package -DskipTests
```

**验证**：
```bash
# 确认jar包已生成
dir target\fictional-1.0-SNAPSHOT.jar
```

#### 1.2 构建前端

```bash
# 在Windows本地
cd C:\gitRepos\fictional\frontend
npm install
npm run build
```

**验证**：
```bash
# 确认dist目录已生成
dir dist
```

---

### 第二步：上传到服务器

#### 2.1 上传后端jar包

```bash
scp C:\gitRepos\fictional\backend\target\fictional-1.0-SNAPSHOT.jar root@123.60.40.72:/home/fiction/backend/target/
```

#### 2.2 上传前端dist目录

```bash
scp -r C:\gitRepos\fictional\frontend\dist root@123.60.40.72:/home/fiction/frontend/
```

#### 2.3 上传nginx配置

```bash
scp C:\gitRepos\fictional\frontend\nginx.conf root@123.60.40.72:/home/fiction/frontend/
```

#### 2.4 上传部署文件

```bash
scp -r C:\gitRepos\fictional\deploy root@123.60.40.72:/home/fiction/
```

#### 2.5 上传后端Dockerfile

```bash
scp C:\gitRepos\fictional\deploy\Dockerfile root@123.60.40.72:/home/fiction/backend/
```

或者使用SFTP工具（WinSCP/FileZilla）上传。

---

### 第三步：执行数据库脚本

```bash
# 连接到数据库服务器
mysql -h 123.60.40.72 -P 10101 -u root -p

# 执行初始化脚本
source /home/fiction/docs/sql/init.sql;

# 执行更新脚本
source /home/fiction/docs/sql/update-application-table.sql;

# 退出
exit;
```

或者上传SQL文件后执行：

```bash
scp C:\gitRepos\fictional\docs\sql\init.sql root@123.60.40.72:/tmp/
scp C:\gitRepos\fictional\docs\sql\update-application-table.sql root@123.60.40.72:/tmp/

ssh root@123.60.40.72
mysql -h 123.60.40.72 -P 10101 -u root -p fiction < /tmp/init.sql
mysql -h 123.60.40.72 -P 10101 -u root -p fiction < /tmp/update-application-table.sql
```

---

### 第四步：在服务器上部署

#### 4.1 连接到服务器

```bash
ssh root@123.60.40.72
```

#### 4.2 检查文件

```bash
cd /home/fiction

# 检查目录结构
ls -la

# 检查关键文件
ls -lh backend/target/fictional-1.0-SNAPSHOT.jar
ls -lh frontend/dist/index.html
ls -lh frontend/nginx.conf
ls -lh deploy/docker-compose.yml
```

#### 4.3 运行部署脚本

```bash
cd /home/fiction/deploy
chmod +x deploy.sh
bash ./deploy.sh
```

---

## 📊 部署脚本执行流程

```
[1/6] 检查Docker环境
      ↓
[2/6] 停止并删除旧容器
      ↓
[3/6] 检查编译产物（jar + dist）
      ↓
[4/6] 构建Docker镜像
      ├─ 后端：fictional-backend:1.2.0
      └─ 前端：fictional-frontend:1.2.0
      ↓
[5/6] 启动容器
      ├─ fictional-backend (端口10104)
      └─ fictional-frontend (端口10100)
      ↓
[6/6] 等待服务启动
      ↓
   部署完成！
```

---

## 🔍 验证部署

### 1. 检查容器状态

```bash
cd /home/fiction/deploy
docker-compose ps
```

**预期输出**：

```
NAME                  STATUS    PORTS
fictional-backend     Up        0.0.0.0:10104->10104/tcp
fictional-frontend    Up        0.0.0.0:10100->80/tcp
```

### 2. 查看日志

```bash
# 查看所有日志
docker-compose logs -f

# 只看后端
docker-compose logs -f fictional-backend

# 只看前端
docker-compose logs -f fictional-frontend
```

### 3. 测试API

```bash
# 测试后端
curl http://localhost:10104/api/cover/home

# 测试前端
curl http://localhost:10100
```

### 4. 浏览器访问

- **前端**：http://123.60.40.72:10100
- **后端API**：http://123.60.40.72:10104/api/cover/home

**登录测试**：
- 学号：admin
- 密码：12345678

---

## 🔧 Docker服务管理

### 启动服务

```bash
cd /home/fiction/deploy
docker-compose start
```

### 停止服务

```bash
docker-compose stop
```

### 重启服务

```bash
# 重启所有
docker-compose restart

# 重启后端
docker-compose restart fictional-backend

# 重启前端
docker-compose restart fictional-frontend
```

### 查看日志

```bash
# 实时日志
docker-compose logs -f

# 最后100行
docker-compose logs --tail=100

# 保存日志到文件
docker-compose logs > deploy.log
```

### 删除容器

```bash
# 停止并删除容器
docker-compose down

# 删除容器和镜像
docker-compose down --rmi all

# 删除容器、镜像和数据卷
docker-compose down --rmi all -v
```

---

## 🔄 更新部署

### 更新后端

```bash
# 1. 本地重新编译
cd C:\gitRepos\fictional\backend
mvn clean package -DskipTests

# 2. 上传新jar包
scp target\fictional-1.0-SNAPSHOT.jar root@123.60.40.72:/home/fiction/backend/target/

# 3. 服务器上重新构建
ssh root@123.60.40.72
cd /home/fiction/deploy
docker-compose build fictional-backend
docker-compose up -d fictional-backend
```

### 更新前端

```bash
# 1. 本地重新构建
cd C:\gitRepos\fictional\frontend
npm run build

# 2. 上传dist目录
scp -r dist root@123.60.40.72:/home/fiction/frontend/

# 3. 服务器上重新构建
ssh root@123.60.40.72
cd /home/fiction/deploy
docker-compose build fictional-frontend
docker-compose up -d fictional-frontend
```

### 更新数据库

```bash
# 1. 上传新的SQL脚本
scp docs\sql\update-xxx.sql root@123.60.40.72:/tmp/

# 2. 执行SQL脚本
ssh root@123.60.40.72
mysql -h 123.60.40.72 -P 10101 -u root -p fiction < /tmp/update-xxx.sql
```

---

## 📦 Docker镜像管理

### 查看镜像

```bash
docker images | grep fictional
```

### 删除镜像

```bash
# 删除指定版本
docker rmi fictional-backend:1.2.0
docker rmi fictional-frontend:1.2.0

# 删除所有未使用的镜像
docker image prune -a
```

### 导出镜像

```bash
# 导出后端
docker save fictional-backend:1.2.0 -o fictional-backend.tar

# 导出前端
docker save fictional-frontend:1.2.0 -o fictional-frontend.tar
```

### 导入镜像

```bash
# 导入后端
docker load -i fictional-backend.tar

# 导入前端
docker load -i fictional-frontend.tar
```

---

## 🐛 故障排查

### 问题1：容器启动失败

**检查日志**：
```bash
docker-compose logs fictional-backend
```

**常见原因**：
- 数据库连接失败
- 端口被占用
- 配置错误

**解决**：
```bash
# 检查端口
netstat -tulpn | grep 10104

# 检查数据库连接
mysql -h 123.60.40.72 -P 10101 -u root -p -e "SELECT 1"
```

### 问题2：前端无法访问

**检查**：
```bash
# 检查nginx日志
docker-compose logs fictional-frontend

# 检查nginx配置
docker-compose exec fictional-frontend cat /etc/nginx/conf.d/default.conf
```

### 问题3：API请求失败

**检查**：
```bash
# 测试后端直接访问
curl http://localhost:10104/api/cover/home

# 测试前端代理
curl http://localhost:10100/api/cover/home

# 检查容器网络
docker network ls
docker network inspect deploy_fictional-network
```

### 问题4：数据库连接失败

**检查**：
```bash
# 测试数据库连接
mysql -h 123.60.40.72 -P 10101 -u root -p -e "USE fiction; SHOW TABLES;"

# 检查防火墙
ufw status
iptables -L -n | grep 10101
```

---

## 🔐 安全建议

### 1. 修改默认密码

```bash
# 登录系统后修改管理员密码
# 或直接在数据库中更新（使用Argon2加密后的密码）
```

### 2. 配置防火墙

```bash
# 只开放必要端口
ufw allow 10100/tcp  # 前端
ufw allow 10104/tcp  # 后端
ufw enable
```

### 3. 使用HTTPS

```bash
# 配置nginx SSL证书
# 修改nginx.conf添加SSL配置
```

### 4. 限制Docker资源

在docker-compose.yml中添加：

```yaml
services:
  fictional-backend:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M
```

---

## 📊 监控和维护

### 查看容器资源使用

```bash
docker stats fictional-backend fictional-frontend
```

### 查看磁盘使用

```bash
# Docker使用的磁盘空间
docker system df

# 清理无用数据
docker system prune -a
```

### 定时备份

创建备份脚本：

```bash
#!/bin/bash
# /home/fiction/backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/home/fiction/backups"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -h 123.60.40.72 -P 10101 -u root -p'密码' fiction > $BACKUP_DIR/fiction_$DATE.sql

# 备份MinIO数据（如果需要）
# mc mirror minio/videos $BACKUP_DIR/minio_$DATE/

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

echo "备份完成：$BACKUP_DIR/fiction_$DATE.sql"
```

添加到crontab：

```bash
crontab -e

# 每天凌晨2点备份
0 2 * * * /home/fiction/backup.sh >> /home/fiction/backup.log 2>&1
```

---

## 📝 完整部署命令速查

### 首次部署

```bash
# 1. 本地编译（Windows）
cd C:\gitRepos\fictional\backend
mvn clean package -DskipTests

cd C:\gitRepos\fictional\frontend
npm run build

# 2. 上传到服务器
scp backend\target\fictional-1.0-SNAPSHOT.jar root@123.60.40.72:/home/fiction/backend/target/
scp -r frontend\dist root@123.60.40.72:/home/fiction/frontend/
scp frontend\nginx.conf root@123.60.40.72:/home/fiction/frontend/
scp -r deploy root@123.60.40.72:/home/fiction/

# 3. 服务器部署
ssh root@123.60.40.72
cd /home/fiction/deploy
bash ./deploy.sh
```

### 日常更新

```bash
# 本地编译
cd backend && mvn clean package -DskipTests
cd frontend && npm run build

# 上传并重启
scp backend/target/*.jar root@123.60.40.72:/home/fiction/backend/target/
scp -r frontend/dist root@123.60.40.72:/home/fiction/frontend/

ssh root@123.60.40.72
cd /home/fiction/deploy
docker-compose restart
```

---

## 🌐 访问地址

部署完成后：

- **前端页面**：http://123.60.40.72:10100
- **后端API**：http://123.60.40.72:10104
- **管理员账号**：admin / 12345678

---

## 📁 服务器目录结构

```
/home/fiction/
├── backend/
│   ├── target/
│   │   └── fictional-1.0-SNAPSHOT.jar
│   └── Dockerfile (来自deploy/Dockerfile)
├── frontend/
│   ├── dist/               # 构建产物
│   ├── nginx.conf          # Nginx配置
│   └── Dockerfile.simple   # 简化的Dockerfile
├── deploy/
│   ├── docker-compose.yml
│   ├── Dockerfile          # 后端Dockerfile
│   ├── nginx.conf
│   ├── deploy.sh
│   └── README.md
└── docs/
    └── sql/
        ├── init.sql
        └── update-application-table.sql
```

---

## 🔄 快速重启

```bash
# 重启后端
cd /home/fiction/deploy
docker-compose restart fictional-backend

# 重启前端
docker-compose restart fictional-frontend

# 重启所有
docker-compose restart
```

---

## 🛠️ 高级配置

### 修改端口

编辑 `deploy/docker-compose.yml`：

```yaml
services:
  fictional-frontend:
    ports:
      - "8080:80"  # 改为8080端口
```

### 配置环境变量

编辑 `deploy/docker-compose.yml`：

```yaml
services:
  fictional-backend:
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://YOUR_HOST:PORT/fiction...
      - SPRING_DATASOURCE_PASSWORD=YOUR_PASSWORD
```

### 配置资源限制

```yaml
services:
  fictional-backend:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
```

---

## ✅ 部署检查清单

### 部署前

- [ ] 本地编译后端成功
- [ ] 本地构建前端成功
- [ ] 数据库已创建并执行SQL脚本
- [ ] MinIO服务正常运行
- [ ] 服务器已安装Docker和Docker Compose
- [ ] 端口10100和10104未被占用

### 部署后

- [ ] 两个容器都在运行
- [ ] 后端API可访问
- [ ] 前端页面可访问
- [ ] 可以正常登录
- [ ] API请求正常
- [ ] 文件上传功能正常

---

## 📞 技术支持

### 查看详细日志

```bash
# 后端日志
docker-compose logs --tail=200 fictional-backend

# 前端nginx日志
docker-compose exec fictional-frontend cat /var/log/nginx/access.log
docker-compose exec fictional-frontend cat /var/log/nginx/error.log
```

### 进入容器调试

```bash
# 进入后端容器
docker-compose exec fictional-backend bash

# 进入前端容器
docker-compose exec fictional-frontend sh

# 检查nginx配置
docker-compose exec fictional-frontend nginx -t
```

### 重新完整部署

```bash
cd /home/fiction/deploy

# 停止并删除所有
docker-compose down --rmi all -v

# 重新部署
bash ./deploy.sh
```

---

**部署版本**：v1.2.1  
**更新日期**：2025-10-08  
**部署方式**：本地编译 + Docker部署  
**前端端口**：10100  
**后端端口**：10104

🎉 **部署成功后记得修改管理员密码！**

