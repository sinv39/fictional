# 数据库初始化说明

## 📋 概述

`init.sql` 文件包含了项目所需的完整数据库初始化脚本，包括：
- 创建数据库
- 创建 6 张核心业务表
- 插入初始化数据（管理员账户、默认封面配置）
- 可选的测试数据

## 🚀 执行方式

### 方式 1：使用 MySQL 命令行

```bash
# 1. 登录 MySQL
mysql -h 123.60.40.72 -P 10101 -u root -p

# 2. 输入密码：aGF0c3VuZSBtaWt1

# 3. 执行 SQL 文件
source /path/to/init.sql

# 或者直接在命令行执行
mysql -h 123.60.40.72 -P 10101 -u root -paGF0c3VuZSBtaWt1 < init.sql
```

### 方式 2：使用 Docker 容器执行

```bash
# 1. 将 SQL 文件复制到容器中
docker cp init.sql mysql-fiction:/tmp/init.sql

# 2. 在容器中执行
docker exec -i mysql-fiction mysql -u root -paGF0c3VuZSBtaWt1 < /tmp/init.sql

# 或者一行命令
docker exec -i mysql-fiction mysql -u root -paGF0c3VuZSBtaWt1 < init.sql
```

### 方式 3：使用数据库管理工具

如果使用 Navicat、DBeaver、MySQL Workbench 等工具：
1. 连接到数据库服务器
2. 打开 `init.sql` 文件
3. 执行整个脚本

## ⚠️ 重要提示

### 1. 管理员密码
脚本中的管理员密码是**占位符**，需要使用真实的 ARGON2 加密值替换！

**临时解决方案**：
- 学号：`admin`
- 密码字段：需要后端代码生成或使用在线工具加密

**生成 ARGON2 密码的方法**：

```java
// Java 代码示例（Spring Boot 项目中）
import org.springframework.security.crypto.argon2.Argon2PasswordEncoder;

public class PasswordGenerator {
    public static void main(String[] args) {
        Argon2PasswordEncoder encoder = new Argon2PasswordEncoder(16, 32, 1, 65536, 3);
        String encoded = encoder.encode("admin123");
        System.out.println(encoded);
    }
}
```

或使用在线工具：https://argon2.online/

**修改步骤**：
1. 生成 ARGON2 密码
2. 在 `init.sql` 第 138 行替换 `$argon2id$v=19$m=65536,t=3,p=4$placeholder`
3. 执行脚本

### 2. 默认封面路径
脚本中设置的封面路径为 `default/home-cover.jpg` 和 `default/intro-cover.jpg`

**需要做的事**：
- 在 MinIO 的 `photo-bucket` 中上传这两张默认图片
- 或者在脚本执行后，通过后端接口/直接修改数据库来更新封面路径

### 3. 数据库删除警告
脚本中包含 `DROP TABLE IF EXISTS` 语句，会删除已存在的表！
- 首次部署：直接执行即可
- 生产环境更新：**务必备份数据后再执行**

如果不想删除现有数据库，请注释掉第 7 行：
```sql
-- DROP DATABASE IF EXISTS fiction;
```

## 📊 创建的表结构

| 表名 | 说明 | 记录数 |
|-----|------|--------|
| tb_user | 用户表 | 1（管理员） |
| tb_application | 申请表 | 0 |
| tb_video | 视频表 | 0 |
| tb_photo | 图片表 | 0 |
| tb_event | 大事记表 | 0 |
| tb_cover_config | 封面配置表 | 2（HOME/INTRO） |

## 🧪 测试数据

脚本中包含注释掉的测试数据，如果是**开发环境**，可以取消注释以便测试：
- 2 个测试用户
- 1 条测试申请
- 2 条测试大事记

位置：`init.sql` 第 165-183 行

## ✅ 验证安装

执行脚本后，可以运行以下 SQL 验证：

```sql
-- 切换到数据库
USE fiction;

-- 查看所有表
SHOW TABLES;

-- 查看管理员账户
SELECT id, student_id, real_name, role FROM tb_user;

-- 查看封面配置
SELECT * FROM tb_cover_config;

-- 查看表结构
DESCRIBE tb_user;
```

预期结果：
- 应该看到 6 张表
- tb_user 有 1 条管理员记录
- tb_cover_config 有 2 条封面配置

## 🔄 重新初始化

如果需要重新初始化数据库（**谨慎操作**）：

```sql
-- 删除数据库
DROP DATABASE IF EXISTS fiction;

-- 重新执行 init.sql
source /path/to/init.sql
```

## 📞 故障排查

### 问题 1：连接被拒绝
```
ERROR 2003 (HY000): Can't connect to MySQL server
```
**解决**：检查 MySQL 容器是否运行，端口映射是否正确

### 问题 2：字符集错误
```
ERROR 1115 (42000): Unknown character set: 'utf8mb4'
```
**解决**：确保使用 MySQL 8.0+ 版本

### 问题 3：权限不足
```
ERROR 1044 (42000): Access denied for user
```
**解决**：确保使用 root 账户或具有创建数据库权限的账户

## 📝 后续步骤

1. ✅ 执行 `init.sql` 创建数据库和表
2. ⚠️ 生成并更新管理员的 ARGON2 密码
3. 📤 上传默认封面图片到 MinIO
4. 🚀 配置并启动 Spring Boot 应用
5. 🧪 测试管理员登录功能
6. ✨ 开始使用系统

